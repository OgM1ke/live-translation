<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>Live Translation ‚Äî demo</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @font-face {
    font-family: 'SF Pro Display';
    src: url('./SFProText-Regular.woff2') format('woff2');
    font-weight: normal;
    font-style: normal;
  }

  @font-face {
    font-family: 'SF Pro Display';
    src: url('./SFProText-Bold.woff2') format('woff2');
    font-weight: bold;
    font-style: normal;
  }

  body {
    font-family: 'SF Pro Display', -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-weight: normal;
  }

  h1 {
    font-weight: bold;
  }

  .file-info {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
    color: #555;
    margin-top: 4px;
  }

  .file-remove {
    cursor: pointer;
    font-weight: bold;
    color: #c00;
  }
</style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-6">

  <div class="text-center mb-6">
    <h1 class="text-3xl font-bold">Live Translation Generator</h1>
    <p style="color: #86868B; font-size: 1.5rem; margin-top: 0.5rem;">
      Create Live Translation images. Tell the world what the real meaning is. Download, share, have fun!
    </p>
  </div>

  <div class="relative bg-white shadow rounded-xl mb-4">
    <canvas id="previewCanvas" width="987" height="720" class="rounded-xl block"></canvas>
  </div>

  <div class="text-center mb-6">
    <h1 class="text-3xl font-bold mb-2">Customize Your Message</h1>
    <p style="color: #86868B; font-size: 1.5rem; margin-top: 0.25rem;">
      Add your text and watch it transform in real-time
    </p>
  </div>

  <div class="grid grid-cols-2 gap-6 w-[950px] mb-6">
  
    <div>
      <label class="block font-semibold mb-1">Left Text</label>
      <textarea id="leftText" rows="4" class="w-full border rounded p-2" placeholder="Text 1"></textarea>
      <p class="small-muted mt-1">Appears in gradient gray to black</p>

      <div class="mt-2">
        <input type="file" id="fileLeft" accept="image/png, image/jpeg" class="hidden">
        <button id="btnLeft" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-full shadow hover:bg-blue-700 transition">
          Add picture
        </button>
        <div id="fileInfoLeft" class="file-info hidden"></div>
        <label class="flex items-center gap-2 mt-2 text-sm text-gray-600">
          <input type="checkbox" id="onlyPic1">
          Use only picture
        </label>
      </div>
    </div>

    
    <div>
      <label class="block font-semibold mb-1">Right Text</label>
      <textarea id="rightText" rows="4" class="w-full border rounded p-2" placeholder="Text 2"></textarea>
      <p class="small-muted mt-1">Appears in purple-to-pink gradient</p>

      <div class="mt-2">
        <input type="file" id="fileRight" accept="image/png, image/jpeg" class="hidden">
        <button id="btnRight" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-full shadow hover:bg-blue-700 transition">
          Add picture
        </button>
        <div id="fileInfoRight" class="file-info hidden"></div>
        <label class="flex items-center gap-2 mt-2 text-sm text-gray-600">
          <input type="checkbox" id="onlyPic2">
          Use only picture
        </label>
      </div>
    </div>
  </div>

  <div class="flex flex-col items-center mt-4 w-full">
    <button id="downloadBtn" class="px-6 py-2 bg-blue-600 text-white font-semibold shadow hover:bg-blue-700 transition rounded-full">
      Download Your Live Translation
    </button>

    <p class="text-xs mt-2 text-center" style="color: #86868B; max-width: 500px;">
      In case this is not abundantly clear: This site is not affiliated with Apple Inc. It's created for fun and to spread joy in life. üòä
    </p>
  </div>

<script>
const canvas = document.getElementById('previewCanvas');
const ctx = canvas.getContext('2d');

const leftTextEl = document.getElementById('leftText');
const rightTextEl = document.getElementById('rightText');
const downloadBtn = document.getElementById('downloadBtn');

const fileLeft = document.getElementById('fileLeft');
const fileRight = document.getElementById('fileRight');
const btnLeft = document.getElementById('btnLeft');
const btnRight = document.getElementById('btnRight');
const fileInfoLeft = document.getElementById('fileInfoLeft');
const fileInfoRight = document.getElementById('fileInfoRight');

const onlyPic1 = document.getElementById('onlyPic1');
const onlyPic2 = document.getElementById('onlyPic2');

const earbudLeft = 317;
const earbudRight = 678;
const sideMargin = 20;
const earGap = 20;
const boxY = 140;
const boxHeight = 420;
const imgBoxWidth = 281;
const imgBoxHeight = 273;

let imgLeft = null;
let imgRight = null;

const baseImage = new Image();
baseImage.crossOrigin = "anonymous";
baseImage.src = 'def.png';
baseImage.onload = () => {
  document.fonts.load("48px 'SF Pro Display'").then(() => draw());
};

function wrapTextToLines(text, maxWidth) {
  if (!text) return [];
  const words = text.split(/\s+/);
  const lines = [];
  let line = '';

  words.forEach(word => {
    const testLine = line ? line + ' ' + word : word;
    if (ctx.measureText(testLine).width <= maxWidth) {
      line = testLine;
    } else {
      if (line) lines.push(line);
      line = word;
    }
  });

  if (line) lines.push(line);
  return lines;
}

function renderTextInBox(text, boxX, boxY, boxWidth, boxHeight, initialFont=48, colorOrGradient='black') {
  if (!text) return;
  const minFont = 10;
  let fontSize = initialFont;
  const lineHeightFactor = 1.1;
  let lines = [];

  while (fontSize >= minFont) {
    ctx.font = `bold ${fontSize}px -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif`;
    lines = wrapTextToLines(text, boxWidth);
    const lineHeight = fontSize * lineHeightFactor;
    const totalHeight = lines.length * lineHeight;
    let maxLineWidth = 0;
    lines.forEach(line => {
      const w = ctx.measureText(line).width;
      if (w > maxLineWidth) maxLineWidth = w;
    });
    if (totalHeight <= boxHeight && maxLineWidth <= boxWidth) break;
    fontSize -= 1;
  }

  ctx.font = `bold ${fontSize}px -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif`;
  ctx.textBaseline = 'top';
  ctx.textAlign = 'center';
  ctx.fillStyle = typeof colorOrGradient === 'function'
    ? colorOrGradient(boxX, boxWidth)
    : colorOrGradient;

  const lineHeight = fontSize * lineHeightFactor;
  const startY = boxY + (boxHeight - lines.length * lineHeight) / 2;
  for (let i = 0; i < lines.length; i++) {
    ctx.fillText(lines[i], boxX + boxWidth/2, startY + i*lineHeight, boxWidth);
  }
}

function drawImageContain(img, x, y, w, h) {
  const iw = img.width;
  const ih = img.height;
  const scale = Math.min(w / iw, h / ih);
  const nw = iw * scale;
  const nh = ih * scale;
  const dx = x + (w - nw) / 2;
  const dy = y + (h - nh) / 2;
  ctx.drawImage(img, dx, dy, nw, nh);
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#fff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  if (baseImage.complete && baseImage.naturalWidth !== 0) {
    ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height);
  }

  const leftBoxX = sideMargin;
  const leftBoxWidth = earbudLeft - earGap - sideMargin;
  const rightBoxX = earbudRight + earGap;
  const rightBoxWidth = canvas.width - sideMargin - rightBoxX;

  const leftGradientCreator = (boxX, boxW) => {
    const g = ctx.createLinearGradient(boxX, 0, boxX + boxW, 0);
    g.addColorStop(0, '#d4d4d4');
    g.addColorStop(1, '#282828');
    return g;
  };

  const rightGradientCreator = (boxX, boxW) => {
    const g = ctx.createLinearGradient(boxX, 0, boxX + boxW, 0);
    g.addColorStop(0.0, '#0a0762');
    g.addColorStop(0.125, '#080d8f');
    g.addColorStop(0.25, '#2919db');
    g.addColorStop(0.375, '#6d22bd');
    g.addColorStop(0.5, '#8a2cc8');
    g.addColorStop(0.625, '#c037c3');
    g.addColorStop(0.75, '#ef2db0');
    g.addColorStop(0.875, '#eb277d');
    g.addColorStop(1.0, '#fa1c65');
    return g;
  };

  
  if (imgLeft) {
    drawImageContain(imgLeft, leftBoxX, boxY, imgBoxWidth, imgBoxHeight);
    if (!onlyPic1.checked) {
      renderTextInBox(leftTextEl.value || 'Text 1',
        leftBoxX, boxY + imgBoxHeight + 10,
        leftBoxWidth, boxHeight - imgBoxHeight - 10,
        40, leftGradientCreator);
    }
  } else {
    renderTextInBox(leftTextEl.value || 'Text 1',
      leftBoxX, boxY, leftBoxWidth, boxHeight,
      56, leftGradientCreator);
  }

  if (imgRight) {
    drawImageContain(imgRight, rightBoxX, boxY, imgBoxWidth, imgBoxHeight);
    if (!onlyPic2.checked) {
      renderTextInBox(rightTextEl.value || 'Text 2',
        rightBoxX, boxY + imgBoxHeight + 10,
        rightBoxWidth, boxHeight - imgBoxHeight - 10,
        40, rightGradientCreator);
    }
  } else {
    renderTextInBox(rightTextEl.value || 'Text 2',
      rightBoxX, boxY, rightBoxWidth, boxHeight,
      56, rightGradientCreator);
  }
}

function handleFile(input, side) {
  const file = input.files[0];
  if (!file) return;
  const img = new Image();
  img.onload = () => {
    if (side === 'left') imgLeft = img;
    if (side === 'right') imgRight = img;
    updateFileInfo(side, file.name);
    draw();
  };
  img.src = URL.createObjectURL(file);
}

function updateFileInfo(side, name) {
  const infoEl = side === 'left' ? fileInfoLeft : fileInfoRight;
  infoEl.innerHTML = `${name} <span class="file-remove">‚úï</span>`;
  infoEl.classList.remove('hidden');

  infoEl.querySelector('.file-remove').onclick = () => {
    if (side === 'left') imgLeft = null;
    if (side === 'right') imgRight = null;
    infoEl.classList.add('hidden');
    draw();
  };
}

btnLeft.addEventListener('click', () => fileLeft.click());
btnRight.addEventListener('click', () => fileRight.click());
fileLeft.addEventListener('change', () => handleFile(fileLeft, 'left'));
fileRight.addEventListener('change', () => handleFile(fileRight, 'right'));


[leftTextEl, rightTextEl, onlyPic1, onlyPic2].forEach(el =>
  el.addEventListener('input', draw)
);

downloadBtn.addEventListener('click', () => {
  try {
    const url = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = url;
    a.download = 'live-translation.png';
    document.body.appendChild(a);
    a.click();
    a.remove();
  } catch (err) {
    console.error(err);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (Live Server).');
  }
});
</script>
</body>
</html>
